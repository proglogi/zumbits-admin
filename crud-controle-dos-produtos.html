<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zumbits | Cadastro de Produtos</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        h2,
        h3 {
            text-align: center;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        form input,
        form select {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        .form-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .form-buttons button {
            padding: 10px 20px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .form-buttons button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        #productList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 30px auto;
            padding: 0;
        }

        /* Estilo para visualiza√ß√£o em lista */
        .list-view .product-card {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            font-size: 14px;
        }

        .list-view .product-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }

        .product-card {
            background-color: #fff;
            padding: 10px;
            font-size: 13px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-card img {
            max-width: 100%;
            height: 100px;
            object-fit: cover;
            margin: 10px 0;
            border-radius: 8px;
        }

        .product-card button {
            margin-top: 10px;
            margin-right: 5px;
            padding: 6px 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #statusMessage {
            margin-top: 10px;
            font-weight: bold;
        }

        .product-list-item {
            padding: 12px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .product-list-item button {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            background-color: #0d6efd;
            color: #fff;
            border: none;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <h2>Cadastro de Produtos</h2>

    <form>
        <input type="text" id="productId" placeholder="ID do Produto">
        <input type="text" id="productDesc" placeholder="Nome do Produto">
        <input type="number" id="productCost" placeholder="Pre√ßo de Custo" step="0.01">
        <input type="number" id="productSale" placeholder="Pre√ßo de Venda" step="0.01">
        <select id="productCategory">
            <option value="">Selecione a Categoria</option>
            <option value="eletronicos">Eletr√¥nicos - PC</option>
            <option value="jogos">Jogos de VideoGame</option>
            <option value="quadrinhos">HQ's</option>
            <option value="posters">Posters</option>
            <option value="colecionaveis">Colecion√°veis</option>
        </select>

        <input type="text" id="productBrand" placeholder="Marca do Produto">
        <input type="number" id="productStock" placeholder="Quantidade em Estoque" min="0">

        <select id="productStatus">
            <option value="">Status</option>
            <option value="em estoque">Em estoque</option>
            <option value="fora de estoque">Fora de estoque</option>
        </select>

        <input type="text" id="productFeatures" placeholder="Caracter√≠sticas">
        <input type="text" id="productSupplier" placeholder="Fornecedor">
        <label>
            Data da Compra:
            <input type="date" id="purchaseDate">
        </label>
        <input type="file" id="productImage" accept="image/*">

        <div class="form-buttons">
            <button type="button" onclick="addProduct()">Adicionar Produto</button>
        </div>
    </form>

    <h3>Lista de Produtos</h3>
    <div style="text-align: center; margin-bottom: 10px;">
        <button id="toggleViewBtn" onclick="toggleViewMode()" style="padding: 8px 15px; border-radius: 6px; background-color: #0d6efd; color: white; border: none; cursor: pointer;">
            Alternar para Lista
        </button>
    </div>


    <div style="text-align: center; margin-bottom: 15px;">
        <input type="text" id="searchInput" placeholder="Buscar por ID ou nome..." style="padding: 8px; width: 90%; max-width: 500px; border-radius: 6px; border: 1px solid #ccc;">
    </div>

    <div style="text-align: center; margin-bottom: 10px;">
        <button id="toggleViewBtn" style="padding: 8px 16px; border-radius: 6px; background-color: #0d6efd; color: white; border: none; cursor: pointer;">Alternar para modo lista üìÑ
        </button>
    </div>


    <div class="product-list" id="productList"></div>

    <script>
        document.addEventListener("DOMContentLoaded",
            function () {
                const firebaseConfig = {
                    apiKey: "AIzaSyCjjy2B9jb2XZW4nIfMj1xDLogZc8oBd9M",
                    authDomain: "estoque-naturale.firebaseapp.com",
                    databaseURL: "https://estoque-naturale-default-rtdb.firebaseio.com",
                    projectId: "estoque-naturale",
                    storageBucket: "estoque-naturale.firebasestorage.app",
                    messagingSenderId: "204707025194",
                    appId: "1:204707025194:web:158dd6235e0996b6e54e53",
                    measurementId: "G-ZJMVMSTSBJ"
                };

                firebase.initializeApp(firebaseConfig);
                const db = firebase.database().ref("produtos");

                const cloudName = 'dsf2txoqr';
                const unsignedUploadPreset = 'meu_uploader';

                const statusDiv = document.createElement('div');
                statusDiv.id = "statusMessage";
                statusDiv.style.textAlign = "center";
                statusDiv.style.marginTop = "15px";
                document.querySelector(".form-buttons").appendChild(statusDiv);

                function showMessage(msg, color = "green") {
                    statusDiv.textContent = msg;
                    statusDiv.style.color = color;
                    setTimeout(() => statusDiv.textContent = "", 3000);
                }

                async function uploadImageToCloudinary(file) {
                    showMessage("Fazendo upload da imagem...", "#0d6efd");
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', unsignedUploadPreset);

                    const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error.message || 'Erro no upload Cloudinary');
                    return data.secure_url;
                }

                let isCardView = true;

                document.getElementById("toggleViewBtn").addEventListener("click", () => {
                    isCardView = !isCardView;
                    document.getElementById("productList").className = isCardView ? "product-list" : "product-list list-view";
                    document.getElementById("toggleViewBtn").textContent = isCardView ? "Alternar para modo lista üìÑ" : "Alternar para modo card üÉè";
                    db.once("value", snapshot => renderProducts(snapshot, document.getElementById("searchInput").value));
                });

                async function addProduct() {
                    const btn = event.target;
                    btn.disabled = true;

                    const get = id => document.getElementById(id).value.trim();
                    const id = get("productId");
                    const desc = get("productDesc");
                    const cost = parseFloat(get("productCost"));
                    const sale = parseFloat(get("productSale"));
                    const category = get("productCategory");
                    const brand = get("productBrand");
                    const stock = parseInt(get("productStock"));
                    const status = get("productStatus");
                    const features = get("productFeatures");
                    const supplier = get("productSupplier");
                    const purchaseDate = document.getElementById("purchaseDate").value;
                    const imageFile = document.getElementById("productImage").files[0];

                    if (!id || !desc || isNaN(cost) || isNaN(sale) || !category) {
                        showMessage("Preencha todos os campos obrigat√≥rios corretamente.", "red");
                        btn.disabled = false;
                        return;
                    }

                    let imageUrl = "";
                    if (imageFile) {
                        try {
                            imageUrl = await uploadImageToCloudinary(imageFile);
                        } catch (error) {
                            showMessage("Erro no upload: " + error.message, "red");
                            btn.disabled = false;
                            return;
                        }
                    }

                    db.child(id).set({
                        descricao: desc,
                        precoCusto: cost,
                        precoVenda: sale,
                        categoria: category,
                        marca: brand,
                        estoque: stock,
                        status: status,
                        caracteristicas: features,
                        fornecedor: supplier,
                        dataCompra: purchaseDate,
                        imagem: imageUrl
                    })
                        .then(() => {
                            showMessage("Produto adicionado com sucesso!");
                            document.querySelectorAll("input, select").forEach(e => e.value = "");
                        })
                        .catch(error => showMessage("Erro ao adicionar: " + error.message, "red"))
                        .finally(() => btn.disabled = false);
                }

                function deleteProduct(id) {
                    if (confirm(`Tem certeza que deseja excluir o produto ${id}?`)) {
                        db.child(id).remove()
                            .then(() => showMessage("Produto exclu√≠do."))
                            .catch(error => showMessage("Erro ao excluir: " + error.message, "red"));
                    }
                }

                function updateProduct(id) {
                    db.child(id).once("value", snapshot => {
                        const data = snapshot.val();
                        const promptWithDefault = (label, value) => prompt(label, value || "");

                        const newDesc = promptWithDefault("Novo nome:", data.descricao);
                        const newCost = parseFloat(promptWithDefault("Novo custo:", data.precoCusto));
                        const newSale = parseFloat(promptWithDefault("Novo pre√ßo de venda:", data.precoVenda));
                        const newCategory = promptWithDefault("Nova categoria:", data.categoria);
                        const newBrand = promptWithDefault("Nova marca:", data.marca);
                        const newStock = parseInt(promptWithDefault("Novo estoque:", data.estoque));
                        const newStatus = promptWithDefault("Novo status:", data.status);
                        const newFeatures = promptWithDefault("Caracter√≠sticas:", data.caracteristicas);
                        const newSupplier = promptWithDefault("Fornecedor:", data.fornecedor);
                        const newPurchaseDate = promptWithDefault("Data da compra (YYYY-MM-DD):", data.dataCompra);

                        if (!newDesc || isNaN(newCost) || isNaN(newSale) || !newCategory) {
                            showMessage("Campos inv√°lidos para atualiza√ß√£o", "red");
                            return;
                        }

                        db.child(id).update({
                            descricao: newDesc,
                            precoCusto: newCost,
                            precoVenda: newSale,
                            categoria: newCategory,
                            marca: newBrand,
                            estoque: newStock,
                            status: newStatus,
                            caracteristicas: newFeatures,
                            fornecedor: newSupplier,
                            dataCompra: newPurchaseDate
                        })
                            .then(() => showMessage("Produto atualizado com sucesso!"))
                            .catch(error => showMessage("Erro ao atualizar: " + error.message, "red"));
                    });
                }

                let currentView = "card"; // "card" ou "lista"

                function renderProducts(snapshot, filter = "") {
                    const list = document.getElementById("productList");
                    list.innerHTML = "";

                    const data = [];
                    snapshot.forEach(child => {
                        const id = child.key;
                        const p = child.val();
                        const name = (p.descricao || "").toLowerCase();
                        const search = filter.toLowerCase();

                        if (id.toLowerCase().includes(search) || name.includes(search)) {
                            data.push({ id, ...p });
                        }
                    });

                    if (currentView === "card") {
                        data.forEach(p => {
                            const div = document.createElement("div");
                            div.className = "product-card";
                            div.innerHTML = `
                                <strong>${p.id || ""}: ${p.descricao || ""}</strong><br>
                                Pre√ßo: R$ ${p.precoVenda?.toFixed(2) || "-"}<br>
                                ${p.imagem ? `<img src="${p.imagem}" alt="Imagem do produto">` : ""}
                                <br>
                                <button onclick="updateProduct('${p.id}')">Editar</button>
                                <button onclick="deleteProduct('${p.id}')">Excluir</button>
                            `;
                            list.appendChild(div);
                        });
                    } else {
                        const table = document.createElement("table");
                        table.style.width = "100%";
                        table.style.borderCollapse = "collapse";
                        table.innerHTML = `
                            <thead style="background:#f0f0f0">
                                <tr>
                                    <th>ID</th><th>Nome</th><th>Pre√ßo Custo</th><th>Pre√ßo Venda</th>
                                    <th>Categoria</th><th>Marca</th><th>Estoque</th>
                                    <th>Status</th><th>Caracter√≠sticas</th><th>Fornecedor</th>
                                    <th>Compra</th><th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;

                        const tbody = table.querySelector("tbody");
                        data.forEach(p => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${p.id}</td>
                                <td>${p.descricao || "-"}</td>
                                <td>R$ ${p.precoCusto?.toFixed(2) || "-"}</td>
                                <td>R$ ${p.precoVenda?.toFixed(2) || "-"}</td>
                                <td>${p.categoria || "-"}</td>
                                <td>${p.marca || "-"}</td>
                                <td>${p.estoque || "0"}</td>
                                <td>${p.status || "-"}</td>
                                <td>${p.caracteristicas || "-"}</td>
                                <td>${p.fornecedor || "-"}</td>
                                <td>${p.dataCompra || "-"}</td>
                                <td>
                                    <button onclick="updateProduct('${p.id}')">Editar</button>
                                    <button onclick="deleteProduct('${p.id}')">Excluir</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });

                        list.appendChild(table);
                    }
                }

                function toggleViewMode() {
                    currentView = currentView === "card" ? "lista" : "card";
                    const btn = document.getElementById("toggleViewBtn");
                    btn.textContent = currentView === "card" ? "Alternar para Lista" : "Alternar para Cards";

                    db.once("value", snapshot => {
                        const filterValue = document.getElementById("searchInput").value.trim();
                        renderProducts(snapshot, filterValue);
                    });
                }



                db.on("value", (snapshot) => {
                    renderProducts(snapshot);
                });

                const searchInput = document.getElementById("searchInput");
                searchInput.addEventListener("input", () => {
                    const filterValue = searchInput.value;
                    db.on("value", (snapshot) => {
                        const filterValue = document.getElementById("searchInput").value.trim();
                        renderProducts(snapshot, filterValue);
                    });
                });

                window.addProduct = addProduct;
                window.deleteProduct = deleteProduct;
                window.updateProduct = updateProduct;
            });
    </script>
</body>

</html>