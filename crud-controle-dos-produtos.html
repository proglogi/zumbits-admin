<!--Página web no formato CRUD para facilitar o processo de cadastro dos produtos no banco de dados Firebase-->
<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Firebase com Cloudinary</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }

        h2,
        h3 {
            text-align: center;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        form input,
        form select {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        .form-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .form-buttons button {
            padding: 10px 20px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .form-buttons button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        #productList {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0;
            list-style: none;
        }

        .product-card {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .product-card img {
            max-width: 120px;
            margin-top: 8px;
            border-radius: 4px;
        }

        .product-card button {
            margin-top: 10px;
            margin-right: 5px;
            padding: 6px 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #statusMessage {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>

</head>

<body>
    <h2>Cadastro de Produtos</h2>

    <form>
        <input type="text" id="productId" placeholder="ID do Produto">
        <input type="text" id="productDesc" placeholder="Nome do Produto">
        <input type="number" id="productCost" placeholder="Preço de Custo" step="0.01">
        <input type="number" id="productSale" placeholder="Preço de Venda" step="0.01">
        <select id="productCategory">
            <option value="">Selecione a Categoria</option>
            <option value="eletronicos">Eletrônicos - PC</option>
            <option value="jogos">Jogos de VideoGame</option>
            <option value="quadrinhos">HQ's</option>
            <option value="posters">Posters</option>
            <option value="colecionaveis">Colecionáveis</option>
        </select>

        <input type="text" id="productBrand" placeholder="Marca do Produto">
        <input type="number" id="productStock" placeholder="Quantidade em Estoque" min="0">

        <select id="productStatus">
            <option value="">Status</option>
            <option value="em estoque">Em estoque</option>
            <option value="fora de estoque">Fora de estoque</option>
        </select>

        <input type="text" id="productFeatures" placeholder="Características">
        <input type="text" id="productSupplier" placeholder="Fornecedor">
        <label>
            Data da Compra:
            <input type="date" id="purchaseDate">
        </label>
        <input type="file" id="productImage" accept="image/*">

        <div class="form-buttons">
            <button type="button" onclick="addProduct()">Adicionar Produto</button>
        </div>
    </form>

    <h3>Lista de Produtos</h3>

    <div style="text-align: center; margin-bottom: 15px;">
        <input type="text" id="searchInput" placeholder="Buscar por ID ou nome..." style="padding: 8px; width: 90%; max-width: 500px; border-radius: 6px; border: 1px solid #ccc;">
    </div>

    <div class="product-list" id="productList"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const firebaseConfig = {
                apiKey: "AIzaSyCjjy2B9jb2XZW4nIfMj1xDLogZc8oBd9M",
                authDomain: "estoque-naturale.firebaseapp.com",
                databaseURL: "https://estoque-naturale-default-rtdb.firebaseio.com",
                projectId: "estoque-naturale",
                storageBucket: "estoque-naturale.firebasestorage.app",
                messagingSenderId: "204707025194",
                appId: "1:204707025194:web:158dd6235e0996b6e54e53",
                measurementId: "G-ZJMVMSTSBJ"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database().ref("produtos");

            const cloudName = 'dsf2txoqr';
            const unsignedUploadPreset = 'meu_uploader';

            const statusDiv = document.createElement('div');
            statusDiv.id = "statusMessage";
            statusDiv.style.textAlign = "center";
            statusDiv.style.marginTop = "15px";
            document.querySelector(".form-buttons").appendChild(statusDiv);

            function showMessage(msg, color = "green") {
                statusDiv.textContent = msg;
                statusDiv.style.color = color;
                setTimeout(() => statusDiv.textContent = "", 3000);
            }

            async function uploadImageToCloudinary(file) {
                showMessage("Fazendo upload da imagem...", "#0d6efd");
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', unsignedUploadPreset);

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error.message || 'Erro no upload Cloudinary');
                return data.secure_url;
            }

            async function addProduct() {
                const btn = event.target;
                btn.disabled = true;

                const get = id => document.getElementById(id).value.trim();
                const id = get("productId");
                const desc = get("productDesc");
                const cost = parseFloat(get("productCost"));
                const sale = parseFloat(get("productSale"));
                const category = get("productCategory");
                const brand = get("productBrand");
                const stock = parseInt(get("productStock"));
                const status = get("productStatus");
                const features = get("productFeatures");
                const supplier = get("productSupplier");
                const purchaseDate = document.getElementById("purchaseDate").value;
                const imageFile = document.getElementById("productImage").files[0];

                if (!id || !desc || isNaN(cost) || isNaN(sale) || !category) {
                    showMessage("Preencha todos os campos obrigatórios corretamente.", "red");
                    btn.disabled = false;
                    return;
                }

                let imageUrl = "";
                if (imageFile) {
                    try {
                        imageUrl = await uploadImageToCloudinary(imageFile);
                    } catch (error) {
                        showMessage("Erro no upload: " + error.message, "red");
                        btn.disabled = false;
                        return;
                    }
                }

                db.child(id).set({
                    descricao: desc,
                    precoCusto: cost,
                    precoVenda: sale,
                    categoria: category,
                    marca: brand,
                    estoque: stock,
                    status: status,
                    caracteristicas: features,
                    fornecedor: supplier,
                    dataCompra: purchaseDate,
                    imagem: imageUrl
                })
                    .then(() => {
                        showMessage("Produto adicionado com sucesso!");
                        document.querySelectorAll("input, select").forEach(e => e.value = "");
                    })
                    .catch(error => showMessage("Erro ao adicionar: " + error.message, "red"))
                    .finally(() => btn.disabled = false);
            }

            function deleteProduct(id) {
                if (confirm(`Tem certeza que deseja excluir o produto ${id}?`)) {
                    db.child(id).remove()
                        .then(() => showMessage("Produto excluído."))
                        .catch(error => showMessage("Erro ao excluir: " + error.message, "red"));
                }
            }

            function updateProduct(id) {
                db.child(id).once("value", snapshot => {
                    const data = snapshot.val();
                    const promptWithDefault = (label, value) => prompt(label, value || "");

                    const newDesc = promptWithDefault("Novo nome:", data.descricao);
                    const newCost = parseFloat(promptWithDefault("Novo custo:", data.precoCusto));
                    const newSale = parseFloat(promptWithDefault("Novo preço de venda:", data.precoVenda));
                    const newCategory = promptWithDefault("Nova categoria:", data.categoria);
                    const newBrand = promptWithDefault("Nova marca:", data.marca);
                    const newStock = parseInt(promptWithDefault("Novo estoque:", data.estoque));
                    const newStatus = promptWithDefault("Novo status:", data.status);
                    const newFeatures = promptWithDefault("Características:", data.caracteristicas);
                    const newSupplier = promptWithDefault("Fornecedor:", data.fornecedor);
                    const newPurchaseDate = promptWithDefault("Data da compra (YYYY-MM-DD):", data.dataCompra);

                    if (!newDesc || isNaN(newCost) || isNaN(newSale) || !newCategory) {
                        showMessage("Campos inválidos para atualização", "red");
                        return;
                    }

                    db.child(id).update({
                        descricao: newDesc,
                        precoCusto: newCost,
                        precoVenda: newSale,
                        categoria: newCategory,
                        marca: newBrand,
                        estoque: newStock,
                        status: newStatus,
                        caracteristicas: newFeatures,
                        fornecedor: newSupplier,
                        dataCompra: newPurchaseDate
                    })
                        .then(() => showMessage("Produto atualizado com sucesso!"))
                        .catch(error => showMessage("Erro ao atualizar: " + error.message, "red"));
                });
            }

            function renderProducts(snapshot, filter = "") {
                const list = document.getElementById("productList");
                list.innerHTML = "";

                snapshot.forEach(child => {
                    const id = child.key;
                    const p = child.val();
                    const name = (p.descricao || "").toLowerCase();
                    const search = filter.toLowerCase();

                    if (id.toLowerCase().includes(search) ||
                        name.includes(search)) {
                        const div = document.createElement("div");
                        div.className = "product-card";
                        div.innerHTML = `
                            <strong>${id}: ${name}</strong><br>
                            Preço Custo: R$ ${p.precoCusto?.toFixed(2) || 0}<br>
                            Preço Venda: R$ ${p.precoVenda?.toFixed(2) || 0}<br>
                            Categoria: ${p.categoria || "-"}<br>
                            Marca: ${p.marca || "-"}<br>
                            Estoque: ${p.estoque || 0}<br>
                            Status: ${p.status || "-"}<br>
                            Características: ${p.caracteristicas || "-"}<br>
                            Fornecedor: ${p.fornecedor || "-"}<br>
                            Compra: ${p.dataCompra || "-"}<br>
                            ${p.imagem ? `<img src="${p.imagem}" alt="Imagem do produto">` : ""}
                            <br><br>
                            <button onclick="updateProduct('${id}')">Editar</button>
                            <button onclick="deleteProduct('${id}')">Excluir</button>
                        `;
                        list.appendChild(div);
                    }
                });
            }
            db.on("value", (snapshot) => {
                renderProducts(snapshot);
            });

            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", () => {
                const filterValue = searchInput.value;
                db.on("value", (snapshot) => {
                    const filterValue = document.getElementById("searchInput").value.trim();
                    renderProducts(snapshot, filterValue);
                });
            });

            window.addProduct = addProduct;
            window.deleteProduct = deleteProduct;
            window.updateProduct = updateProduct;
        });
    </script>
</body>

</html>